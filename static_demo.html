<!-- filename: static_demo.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>AI Blind Captcha Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Helvetica, Arial; padding: 24px; background: #f5f5f5; }
    .box { max-width: 900px; margin: auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    video {
      width: 640px;
      height: 360px;
      background: #000;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    video:hover {
      box-shadow: 0 4px 15px rgba(0,123,255,0.3);
      transform: scale(1.02);
    }
    .row { margin: 12px 0; }
    .hint { color: #555; }
    .controls { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
    .control-group { margin: 10px 0; }
    label { display: inline-block; width: 120px; font-weight: bold; }
    select, input, button { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #007bff; color: white; cursor: pointer; }
    button:hover { background: #0056b3; }
    .depth-controls { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .file-input { margin: 10px 0; }
    .info { background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #007bff; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
<div class="box">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 id="pageTitle">AI Blind Captcha Demo</h2>
    <div class="language-toggle">
      <button id="langToggle" onclick="toggleLanguage()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
        English
      </button>
    </div>
  </div>

  <div id="description" class="info">
    <strong id="descriptionLabel">说明：</strong><span id="descriptionText">此演示展示了基于论文Time Blindness介绍的原理，开发了一套AI 不可识别的验证码系统，包括了几种不同模式：文本、形状和深度图。</span> 论文信息： <a href="https://arxiv.org/pdf/2505.24867">Time Blindness: Why Video-Language Models Can't See What Humans Can?</a>
  </div>

  <div class="controls">
    <div class="control-group">
      <label id="modeLabel" for="mode">验证码模式:</label>
      <select id="mode" onchange="updateModeControls()">
        <option id="textMode" value="text">文本模式</option>
        <option id="shapeMode" value="shape">形状模式</option>
        <option id="depthMode" value="depth">深度图模式</option>
        <option id="randomMode" value="random">随机模式</option>
      </select>
    </div>

    <div class="control-group">
      <label id="difficultyLabel" for="difficulty">难度等级:</label>
      <select id="difficulty">
        <option id="easyDifficulty" value="easy">简单</option>
        <option id="mediumDifficulty" value="medium" selected>中等</option>
        <option id="hardDifficulty" value="hard">困难</option>
      </select>
    </div>

    <button id="btn-new">获取验证码</button>
    <button id="btn-hint">显示提示</button>
    <span id="expires" class="hint"></span>
  </div>

  <!-- 深度图控制面板 -->
  <div id="depthControls" class="depth-controls" style="display: none;">
    <h4 id="depthSettingsTitle">深度图设置</h4>
    <div class="file-input">
      <label id="depthImageLabel" for="depthImage">选择深度图:</label>
      <input type="file" id="depthImage" accept="image/*" onchange="loadDepthImage(event)">
    </div>
    <div class="control-group">
      <label id="thresholdLowLabel" for="thresholdLow">阈值下限 (tl):</label>
      <input type="number" id="thresholdLow" value="0.2" min="0" max="1" step="0.1">
    </div>
    <div class="control-group">
      <label id="thresholdHighLabel" for="thresholdHigh">阈值上限 (tu):</label>
      <input type="number" id="thresholdHigh" value="0.8" min="0" max="1" step="0.1">
    </div>
  </div>
  <div class="row">
    <video id="vid" controls loop autoplay muted></video>
  </div>
  <div class="row">
    <input id="answer" placeholder="请输入看到的内容" />
    <button id="btn-verify">提交校验</button>
  </div>
  <div class="row">
    <div id="hint" class="hint"></div>
    <div id="msg"></div>
  </div>
  
</div>

<script>
let currentId = null;
let depthImageData = null;
let currentLang = 'zh'; // 'zh' for Chinese, 'en' for English

// Language translations
const translations = {
  zh: {
    pageTitle: "AI Blind Captcha Demo",
    descriptionLabel: "说明：",
    descriptionText: "此演示展示了基于论文Time Blindness介绍的原理，开发了一套AI 不可识别的验证码系统，包括了几种不同模式：文本、形状和深度图。",
    modeLabel: "验证码模式:",
    textMode: "文本模式",
    shapeMode: "形状模式",
    depthMode: "深度图模式",
    randomMode: "随机模式",
    difficultyLabel: "难度等级:",
    easyDifficulty: "简单",
    mediumDifficulty: "中等",
    hardDifficulty: "困难",
    btnNew: "获取验证码",
    btnHint: "显示提示",
    depthSettingsTitle: "深度图设置",
    depthImageLabel: "选择深度图:",
    thresholdLowLabel: "阈值下限 (tl):",
    thresholdHighLabel: "阈值上限 (tu):",
    answerPlaceholder: "请输入看到的内容",
    btnVerify: "提交校验",
    langButton: "English",
    expiresPrefix: "有效期至: ",
    clickToPlay: "请点击视频播放按钮开始播放（已设置循环播放）",
    generateFailed: "生成验证码失败",
    connectionFailed: "连接服务器失败: ",
    pleaseGetCaptcha: "请先获取验证码",
    pleaseEnterAnswer: "请输入答案",
    getHintFailed: "获取提示失败",
    hintPrefix: "提示: ",
    verifySuccess: "验证成功",
    verifyFailed: "答案不正确",
    captchaNotExists: "验证码不存在或已过期",
    captchaExpired: "验证码已过期",
    tooManyAttempts: "尝试次数过多，已失效"
  },
  en: {
    pageTitle: "AI Blind Captcha Demo",
    descriptionLabel: "Description: ",
    descriptionText: "This demo showcases a CAPTCHA system based on the Time Blindness paper, featuring multiple modes: text, shape, and depth images.",
    modeLabel: "CAPTCHA Mode:",
    textMode: "Text Mode",
    shapeMode: "Shape Mode",
    depthMode: "Depth Mode",
    randomMode: "Random Mode",
    difficultyLabel: "Difficulty:",
    easyDifficulty: "Easy",
    mediumDifficulty: "Medium",
    hardDifficulty: "Hard",
    btnNew: "Get New CAPTCHA",
    btnHint: "Show Hint",
    depthSettingsTitle: "Depth Image Settings",
    depthImageLabel: "Select Depth Image:",
    thresholdLowLabel: "Threshold Low (tl):",
    thresholdHighLabel: "Threshold High (tu):",
    answerPlaceholder: "Enter what you see",
    btnVerify: "Submit",
    langButton: "中文",
    expiresPrefix: "Expires at: ",
    clickToPlay: "Please click the video play button to start (loop playback enabled)",
    generateFailed: "Failed to generate CAPTCHA",
    connectionFailed: "Connection failed: ",
    pleaseGetCaptcha: "Please get a CAPTCHA first",
    pleaseEnterAnswer: "Please enter an answer",
    getHintFailed: "Failed to get hint",
    hintPrefix: "Hint: ",
    verifySuccess: "Verification successful",
    verifyFailed: "Incorrect answer",
    captchaNotExists: "CAPTCHA does not exist or has expired",
    captchaExpired: "CAPTCHA has expired",
    tooManyAttempts: "Too many attempts, CAPTCHA invalidated"
  }
};

function updateLanguage() {
  const t = translations[currentLang];

  // Update page title and html lang attribute
  document.getElementById('pageTitle').textContent = t.pageTitle;
  document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';

  // Update description
  document.getElementById('descriptionLabel').textContent = t.descriptionLabel;
  document.getElementById('descriptionText').textContent = t.descriptionText;

  // Update controls
  document.getElementById('modeLabel').textContent = t.modeLabel;
  document.getElementById('textMode').textContent = t.textMode;
  document.getElementById('shapeMode').textContent = t.shapeMode;
  document.getElementById('depthMode').textContent = t.depthMode;
  document.getElementById('randomMode').textContent = t.randomMode;

  document.getElementById('difficultyLabel').textContent = t.difficultyLabel;
  document.getElementById('easyDifficulty').textContent = t.easyDifficulty;
  document.getElementById('mediumDifficulty').textContent = t.mediumDifficulty;
  document.getElementById('hardDifficulty').textContent = t.hardDifficulty;

  document.getElementById('btn-new').textContent = t.btnNew;
  document.getElementById('btn-hint').textContent = t.btnHint;

  // Update depth controls
  document.getElementById('depthSettingsTitle').textContent = t.depthSettingsTitle;
  document.getElementById('depthImageLabel').textContent = t.depthImageLabel;
  document.getElementById('thresholdLowLabel').textContent = t.thresholdLowLabel;
  document.getElementById('thresholdHighLabel').textContent = t.thresholdHighLabel;

  // Update input and button
  const answerInput = document.getElementById('answer');
  answerInput.placeholder = t.answerPlaceholder;
  document.getElementById('btn-verify').textContent = t.btnVerify;

  // Update language toggle button
  document.getElementById('langToggle').textContent = t.langButton;
}

function toggleLanguage() {
  currentLang = currentLang === 'zh' ? 'en' : 'zh';
  updateLanguage();
  localStorage.setItem('preferredLanguage', currentLang);
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  // Load saved language preference
  const savedLang = localStorage.getItem('preferredLanguage');
  if (savedLang && ['zh', 'en'].includes(savedLang)) {
    currentLang = savedLang;
  }
  updateLanguage();
  updateModeControls();
});

function updateModeControls() {
  const mode = document.getElementById('mode').value;
  const depthControls = document.getElementById('depthControls');

  if (mode === 'depth') {
    depthControls.style.display = 'block';
  } else {
    depthControls.style.display = 'none';
  }
}

function loadDepthImage(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        depthImageData = canvas.toDataURL();
        console.log('深度图已加载');
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

async function newCaptcha() {
  const mode = document.getElementById('mode').value;
  const difficulty = document.getElementById('difficulty').value;

  let requestData = {
    mode: mode === 'random' ? ['text', 'shape', 'depth'][Math.floor(Math.random() * 3)] : mode,
    difficulty: difficulty
  };

  // 如果是深度图模式且有深度图数据
  if (requestData.mode === 'depth' && depthImageData) {
    const tl = parseFloat(document.getElementById('thresholdLow').value);
    const tu = parseFloat(document.getElementById('thresholdHigh').value);
    requestData.threshold_low = tl;
    requestData.threshold_high = tu;
    requestData.depth_image = depthImageData;
  }

  try {
    const resp = await fetch('/captcha/new', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });

    if (resp.ok) {
      const data = await resp.json();
      console.log('Response data:', data); // Debug log

      if (!data.video_base64) {
        throw new Error('No video data received');
      }

      currentId = data.id;
      document.getElementById('hint').textContent = data.hint;
      const t = translations[currentLang];
      document.getElementById('expires').textContent =
        t.expiresPrefix + new Date(data.expires_at * 1000).toLocaleString();

      const b64 = data.video_base64;
      const src = 'data:video/mp4;base64,' + b64;
      const vid = document.getElementById('vid');

      console.log('Video source length:', src.length); // Debug log

      // Reset video properties
      vid.src = src;
      vid.loop = true;        // Enable loop
      vid.muted = true;       // Start muted to allow autoplay
      vid.volume = 0.5;       // Set volume to 50% when unmuted
      vid.load();             // Explicitly load the video

      // Add event listeners for debugging and better user experience
      vid.addEventListener('loadstart', () => console.log('Video loading started'));
      vid.addEventListener('loadeddata', () => console.log('Video data loaded'));
      vid.addEventListener('canplay', () => {
        console.log('Video can play - enabling loop');
        vid.loop = true;
      });
      vid.addEventListener('ended', () => {
        console.log('Video ended - restarting loop');
        vid.currentTime = 0;
        vid.play().catch(e => console.log('Loop play failed:', e));
      });
      vid.addEventListener('error', (e) => console.error('Video error:', e));

      // Try to play with better autoplay handling
      const playPromise = vid.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log('Video started playing successfully');
          // Optionally unmute after successful autoplay
          setTimeout(() => {
            if (vid.muted) {
              vid.muted = false;
              console.log('Video unmuted after successful start');
            }
          }, 1000);
        }).catch((error) => {
          console.log('Autoplay prevented, waiting for user interaction:', error);
          const t = translations[currentLang];
          document.getElementById('msg').textContent = t.clickToPlay;
          document.getElementById('msg').className = 'hint';

          // Add click listener to start playing on user interaction
          vid.addEventListener('click', () => {
            vid.muted = false;
            vid.play().catch(e => console.log('Click play failed:', e));
          }, { once: true });
        });
      }

      // 清除之前的消息
      document.getElementById('msg').textContent = '';
      document.getElementById('msg').className = '';
    } else {
      const t = translations[currentLang];
      document.getElementById('msg').textContent = t.generateFailed;
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    console.error('Error in newCaptcha:', error);
    const t = translations[currentLang];
    document.getElementById('msg').textContent = t.connectionFailed + error.message;
    document.getElementById('msg').className = 'error';
  }
}

async function verifyCaptcha() {
  const t = translations[currentLang];
  if (!currentId) {
    document.getElementById('msg').textContent = t.pleaseGetCaptcha;
    document.getElementById('msg').className = 'error';
    return;
  }

  const ans = document.getElementById('answer').value.trim();
  if (!ans) {
    document.getElementById('msg').textContent = t.pleaseEnterAnswer;
    document.getElementById('msg').className = 'error';
    return;
  }

  try {
    const resp = await fetch('/captcha/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: currentId, answer: ans })
    });

    const data = await resp.json();
    document.getElementById('msg').textContent = data.message;

    if (data.success) {
      document.getElementById('msg').className = 'success';
    } else {
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    const t = translations[currentLang];
    document.getElementById('msg').textContent = t.connectionFailed + error.message;
    document.getElementById('msg').className = 'error';
  }
}

async function showHint() {
  const t = translations[currentLang];
  if (!currentId) {
    document.getElementById('msg').textContent = t.pleaseGetCaptcha;
    document.getElementById('msg').className = 'error';
    return;
  }

  try {
    const resp = await fetch(`/captcha/hint/${currentId}`, {
      method: 'GET'
    });

    if (resp.ok) {
      const data = await resp.json();
      alert(t.hintPrefix + data.hint);
    } else {
      document.getElementById('msg').textContent = t.getHintFailed;
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    document.getElementById('msg').textContent = t.connectionFailed + error.message;
    document.getElementById('msg').className = 'error';
  }
}

// 事件监听器
document.getElementById('btn-new').addEventListener('click', newCaptcha);
document.getElementById('btn-verify').addEventListener('click', verifyCaptcha);
document.getElementById('btn-hint').addEventListener('click', showHint);

// 添加回车键提交功能
document.getElementById('answer').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    verifyCaptcha();
  }
});
</script>
</body>
</html>
