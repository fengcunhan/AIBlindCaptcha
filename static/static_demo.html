<!-- filename: static_demo.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>AI Blind Captcha Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Helvetica, Arial; padding: 24px; background: #f5f5f5; }
    .box { max-width: 900px; margin: auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    video {
      width: 640px;
      height: 360px;
      background: #000;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    video:hover {
      box-shadow: 0 4px 15px rgba(0,123,255,0.3);
      transform: scale(1.02);
    }
    .row { margin: 12px 0; }
    .hint { color: #555; }
    .controls { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
    .control-group { margin: 10px 0; }
    label { display: inline-block; width: 120px; font-weight: bold; }
    select, input, button { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #007bff; color: white; cursor: pointer; }
    button:hover { background: #0056b3; }
    .depth-controls { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .file-input { margin: 10px 0; }
    .info { background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #007bff; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
<div class="box">
  <h2>AI Blind Captcha Demo</h2>

  <div class="info">
    <strong>说明：</strong>此演示展示了AI盲人验证码的不同模式：文本、形状和深度图。
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="mode">验证码模式:</label>
      <select id="mode" onchange="updateModeControls()">
        <option value="text">文本模式</option>
        <option value="shape">形状模式</option>
        <option value="depth">深度图模式</option>
        <option value="random">随机模式</option>
      </select>
    </div>

    <div class="control-group">
      <label for="difficulty">难度等级:</label>
      <select id="difficulty">
        <option value="easy">简单</option>
        <option value="medium" selected>中等</option>
        <option value="hard">困难</option>
      </select>
    </div>

    <button id="btn-new">获取验证码</button>
    <button id="btn-hint">显示提示</button>
    <span id="expires" class="hint"></span>
  </div>

  <!-- 深度图控制面板 -->
  <div id="depthControls" class="depth-controls" style="display: none;">
    <h4>深度图设置</h4>
    <div class="file-input">
      <label for="depthImage">选择深度图:</label>
      <input type="file" id="depthImage" accept="image/*" onchange="loadDepthImage(event)">
    </div>
    <div class="control-group">
      <label for="thresholdLow">阈值下限 (tl):</label>
      <input type="number" id="thresholdLow" value="0.2" min="0" max="1" step="0.1">
    </div>
    <div class="control-group">
      <label for="thresholdHigh">阈值上限 (tu):</label>
      <input type="number" id="thresholdHigh" value="0.8" min="0" max="1" step="0.1">
    </div>
  </div>
  <div class="row">
    <video id="vid" controls loop autoplay muted></video>
  </div>
  <div class="row">
    <input id="answer" placeholder="请输入看到的内容" />
    <button id="btn-verify">提交校验</button>
  </div>
  <div class="row">
    <div id="hint" class="hint"></div>
    <div id="msg"></div>
  </div>
</div>

<script>
let currentId = null;
let depthImageData = null;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  updateModeControls();
});

function updateModeControls() {
  const mode = document.getElementById('mode').value;
  const depthControls = document.getElementById('depthControls');

  if (mode === 'depth') {
    depthControls.style.display = 'block';
  } else {
    depthControls.style.display = 'none';
  }
}

function loadDepthImage(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        depthImageData = canvas.toDataURL();
        console.log('深度图已加载');
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

async function newCaptcha() {
  const mode = document.getElementById('mode').value;
  const difficulty = document.getElementById('difficulty').value;

  let requestData = {
    mode: mode === 'random' ? ['text', 'shape', 'depth'][Math.floor(Math.random() * 3)] : mode,
    difficulty: difficulty
  };

  // 如果是深度图模式且有深度图数据
  if (requestData.mode === 'depth' && depthImageData) {
    const tl = parseFloat(document.getElementById('thresholdLow').value);
    const tu = parseFloat(document.getElementById('thresholdHigh').value);
    requestData.threshold_low = tl;
    requestData.threshold_high = tu;
    requestData.depth_image = depthImageData;
  }

  try {
    const resp = await fetch('/captcha/new', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    });

    if (resp.ok) {
      const data = await resp.json();
      console.log('Response data:', data); // Debug log

      if (!data.video_base64) {
        throw new Error('No video data received');
      }

      currentId = data.id;
      document.getElementById('hint').textContent = data.hint;
      document.getElementById('expires').textContent =
        '有效期至: ' + new Date(data.expires_at * 1000).toLocaleString();

      const b64 = data.video_base64;
      const src = 'data:video/mp4;base64,' + b64;
      const vid = document.getElementById('vid');

      console.log('Video source length:', src.length); // Debug log

      // Reset video properties
      vid.src = src;
      vid.loop = true;        // Enable loop
      vid.muted = true;       // Start muted to allow autoplay
      vid.volume = 0.5;       // Set volume to 50% when unmuted
      vid.load();             // Explicitly load the video

      // Add event listeners for debugging and better user experience
      vid.addEventListener('loadstart', () => console.log('Video loading started'));
      vid.addEventListener('loadeddata', () => console.log('Video data loaded'));
      vid.addEventListener('canplay', () => {
        console.log('Video can play - enabling loop');
        vid.loop = true;
      });
      vid.addEventListener('ended', () => {
        console.log('Video ended - restarting loop');
        vid.currentTime = 0;
        vid.play().catch(e => console.log('Loop play failed:', e));
      });
      vid.addEventListener('error', (e) => console.error('Video error:', e));

      // Try to play with better autoplay handling
      const playPromise = vid.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log('Video started playing successfully');
          // Optionally unmute after successful autoplay
          setTimeout(() => {
            if (vid.muted) {
              vid.muted = false;
              console.log('Video unmuted after successful start');
            }
          }, 1000);
        }).catch((error) => {
          console.log('Autoplay prevented, waiting for user interaction:', error);
          document.getElementById('msg').textContent = '请点击视频播放按钮开始播放（已设置循环播放）';
          document.getElementById('msg').className = 'hint';

          // Add click listener to start playing on user interaction
          vid.addEventListener('click', () => {
            vid.muted = false;
            vid.play().catch(e => console.log('Click play failed:', e));
          }, { once: true });
        });
      }

      // 清除之前的消息
      document.getElementById('msg').textContent = '';
      document.getElementById('msg').className = '';
    } else {
      document.getElementById('msg').textContent = '生成验证码失败';
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    console.error('Error in newCaptcha:', error);
    document.getElementById('msg').textContent = '连接服务器失败: ' + error.message;
    document.getElementById('msg').className = 'error';
  }
}

async function verifyCaptcha() {
  if (!currentId) {
    document.getElementById('msg').textContent = '请先获取验证码';
    document.getElementById('msg').className = 'error';
    return;
  }

  const ans = document.getElementById('answer').value.trim();
  if (!ans) {
    document.getElementById('msg').textContent = '请输入答案';
    document.getElementById('msg').className = 'error';
    return;
  }

  try {
    const resp = await fetch('/captcha/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: currentId, answer: ans })
    });

    const data = await resp.json();
    document.getElementById('msg').textContent = data.message;

    if (data.success) {
      document.getElementById('msg').className = 'success';
    } else {
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    document.getElementById('msg').textContent = '连接服务器失败: ' + error.message;
    document.getElementById('msg').className = 'error';
  }
}

async function showHint() {
  if (!currentId) {
    document.getElementById('msg').textContent = '请先获取验证码';
    document.getElementById('msg').className = 'error';
    return;
  }

  try {
    const resp = await fetch(`/captcha/hint/${currentId}`, {
      method: 'GET'
    });

    if (resp.ok) {
      const data = await resp.json();
      alert('提示: ' + data.hint);
    } else {
      document.getElementById('msg').textContent = '获取提示失败';
      document.getElementById('msg').className = 'error';
    }
  } catch (error) {
    document.getElementById('msg').textContent = '连接服务器失败: ' + error.message;
    document.getElementById('msg').className = 'error';
  }
}

// 事件监听器
document.getElementById('btn-new').addEventListener('click', newCaptcha);
document.getElementById('btn-verify').addEventListener('click', verifyCaptcha);
document.getElementById('btn-hint').addEventListener('click', showHint);

// 添加回车键提交功能
document.getElementById('answer').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    verifyCaptcha();
  }
});
</script>
</body>
</html>
